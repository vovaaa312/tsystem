input {
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/vendor/jar/jdbc/postgresql-42.7.4.jar"
    jdbc_driver_class   => "org.postgresql.Driver"
    jdbc_connection_string => "jdbc:postgresql://postgres:5432/tsystem"
    jdbc_user => "app"
    jdbc_password => "app"
    schedule => "*/15 * * * * *"  # каждые 15 сек
    clean_run => false
    # Вытаскиваем тикеты вместе с проектом и назначенным пользователем
    statement => "
      SELECT
        t.id::text            AS id,
        t.name                AS name,
        t.description         AS description,
        t.type                AS type,
        t.priority            AS priority,
        t.state               AS status,
        t.created_at          AS createdAt,
        t.updated_at          AS updatedAt,
        t.project_id::text    AS projectId,
        p.name                AS projectName,
        t.user_id::text       AS assigneeId,
        u.username            AS assigneeUsername
      FROM app.tickets t
      JOIN app.projects p ON p.id = t.project_id
      LEFT JOIN app.users u ON u.id = t.user_id
      WHERE t.deleted = false OR t.deleted IS NULL
    "
  }
}

filter {
  mutate {
    # Нормализуем типы и имена полей под ES
    rename => { "status" => "state" }
    convert => {
      "projectId" => "string"
      "assigneeId" => "string"
    }
  }
  # Даты в ISO8601
  date { match => ["createdAt","ISO8601"] target => "createdAt" }
  date { match => ["updatedAt","ISO8601"] target => "updatedAt" }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "tickets"
    document_id => "%{id}"
    action => "index"
  }
  stdout { codec => json_lines }
}
