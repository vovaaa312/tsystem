

input {
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/lib/postgresql.jar"
    jdbc_driver_class   => "org.postgresql.Driver"

    jdbc_connection_string => "jdbc:postgresql://postgres:5432/tsystem"
    jdbc_user => "app"
    jdbc_password => "app"

    # раз в 30 секунд
    schedule => "*/30 * * * * *"

    # инкрементальная загрузка по changed_at из ticket_history
    use_column_value        => true
    tracking_column         => "changed_at"
    tracking_column_type    => "timestamp"
    last_run_metadata_path  => "/usr/share/logstash/.logstash_tickets_last_run"

    statement => "
      SELECT
        t.id,
        t.name,
        t.description,
        t.type        AS type,
        t.priority    AS priority,
        t.state       AS state,
        t.project_id,
        p.name        AS project_name,
        t.author_id,
        author.username   AS author_username,
        t.assigned_user_id,
        assignee.username AS assignee_username,
        t.created_at,
        th.changed_at     AS changed_at
      FROM ticket_history th
      JOIN tickets  t        ON t.id          = th.ticket_id
      JOIN projects p        ON p.id          = t.project_id
      JOIN users    author   ON author.id     = t.author_id
      LEFT JOIN users assignee ON assignee.id = t.assigned_user_id
      WHERE th.changed_at > :sql_last_value
      ORDER BY th.changed_at
    "
  }
}

filter {
  # пока фильтров нет
}

output {
  elasticsearch {
    hosts => [ "http://elasticsearch:9200" ]
    index => "tickets"
    document_id => "%{id}"
  }

  stdout {
    codec => json
  }
}
